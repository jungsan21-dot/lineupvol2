<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë„ë‹´ë§ˆë£¨ ë„ì„œê´€ ì›” ì¶œì„ë¶€ (v4.0.1)</title>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_four@1.2/JalnanGothic.woff');

        @keyframes pop-in {
            0% { transform: scale(0.9); } 50% { transform: scale(1.1); } 100% { transform: scale(1); }
        }

        :root {
            --bg-color: #f1f5f9;
            --container-bg: #ffffff;
            --border-color: #e5e7eb;
            --header-bg: linear-gradient(135deg, #f97316, #facc15);
            --text-color: #374151;
            --header-text-color: #ffffff;
            --button-disabled-bg: #9ca3af;
        }

        body {
            font-family: 'JalnanGothic', 'Malgun Gothic', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 1vh 1vw;
            color: var(--text-color);
            height: 100vh;
            box-sizing: border-box;
            overflow: hidden;
        }

        .container {
            width: 100%;
            height: 100%;
            background-color: var(--container-bg);
            border-radius: 20px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            background: var(--header-bg);
            color: var(--header-text-color);
            padding: clamp(12px, 1.5vh, 15px) clamp(15px, 2vw, 25px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        header h1 { 
            margin: 0; 
            font-size: clamp(24px, 3vh, 32px);
            text-shadow: 1px 1px 3px rgba(0,0,0,0.2); 
        }
        
        .header-controls { display: flex; align-items: center; gap: 15px; }
        #version-display { font-size: clamp(12px, 1.5vh, 14px); font-weight: bold; opacity: 0.8; }

        #admin-button {
            padding: clamp(8px, 1vh, 10px) clamp(14px, 1.5vw, 18px);
            font-size: clamp(12px, 1.5vh, 14px);
            border: none; background-color: rgba(255, 255, 255, 0.25);
            color: var(--header-text-color); border-radius: 10px; cursor: pointer;
            font-weight: bold; transition: background-color 0.3s;
        }
        #admin-button:hover { background-color: rgba(255, 255, 255, 0.4); }

        #date-display-section {
            display: flex;
            justify-content: space-around;
            padding: 1.5vh 1vw;
            background-color: #f8fafc;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        .date-box { text-align: center; }
        .date-box h2 {
            font-size: clamp(18px, 3vh, 24px);
            margin: 0 0 1vh 0;
        }
        .date-content {
            display: flex;
            align-items: baseline;
            line-height: 1;
        }
        .date-number {
            font-size: clamp(40px, 8vh, 64px);
            font-weight: bold;
        }
        .date-text {
            font-size: clamp(18px, 3vh, 24px);
            margin: 0 0.5vw;
        }
        .loan-date h2 { color: #16a34a; }
        .loan-date .date-number { color: #15803d; }
        .return-date h2 { color: #f97316; }
        .return-date .date-number { color: #c2410c; }
        
        #chart-container {
            flex-grow: 1;
            padding: 1vw;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            grid-auto-rows: min-content;
            gap: 1vw;
            overflow-y: auto;
        }

        .student-card {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 1vh;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .student-name {
            font-weight: bold;
            font-size: clamp(1.1em, 2.2vh, 1.4em);
            margin-bottom: 0.5vh;
        }
        
        .attendance-info { margin: 0.5vh 0; }
        .attendance-info .count {
            font-size: clamp(1.2em, 2.5vh, 1.6em);
            font-weight: bold;
            color: #2563eb;
        }
        .attendance-info .label {
            font-size: clamp(0.8em, 1.2vh, 0.9em);
            color: #6b7280;
        }

        .action-buttons {
            margin-top: auto;
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: center;
            width: 100%;
            min-height: 7vh;
        }

        .circular-btn {
            width: clamp(48px, 6.5vh, 64px);
            height: clamp(48px, 6.5vh, 64px);
            border-radius: 50%; border: none; color: white;
            font-weight: bold; font-size: clamp(0.9em, 1.6vh, 1em);
            cursor: pointer; transition: all 0.2s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .circular-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.2); }
        .circular-btn:disabled { 
            background-color: var(--button-disabled-bg) !important; 
            cursor: not-allowed; box-shadow: none; 
        }
        .undo-btn { 
            cursor: pointer; 
            background-color: var(--button-disabled-bg) !important;
        }

        .gift-btn-container { display: flex; flex-direction: column; gap: 4px; }
        .gift-btn {
            width: clamp(32px, 4.5vh, 40px); height: clamp(32px, 4.5vh, 40px);
            font-size: clamp(1em, 2.2vh, 1.2em);
            border-radius: 50%; border: none; color: white;
            cursor: pointer; transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            background-color: #ea580c;
        }
        .gift-btn:hover:not(:disabled) { transform: translateY(-2px); }
        .gift-btn:disabled { background-color: #9ca3af; cursor: not-allowed; box-shadow: none; }

        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5);
            justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: #fefefe; padding: 25px; border-radius: 12px;
            width: 400px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); position: relative;
        }
        .modal-content h2, .modal-content h3 { margin-top: 0; color: #374151; }
        .modal-content h3 { font-size: 1.1em; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .modal-content label { display: block; margin-top: 10px; margin-bottom: 5px; font-weight: bold; font-size: 0.9em;}
        .modal-content input, .modal-content select, .modal-content button {
            width: 100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box;
            border-radius: 6px; border: 1px solid #ccc;
        }
        .modal-content button { border: none; color: white; cursor: pointer; }
        .modal-content .input-group { display: flex; gap: 5px; }
        .modal-content .input-group input { flex-grow: 1; }
        .modal-close-button { background-color: #aaa; }
        .modal-save-button { background-color: #f97316; }

        #gacha-modal .modal-content { width: 100%; height: 100%; padding: 0; overflow: hidden; border-radius: 0;}
        #gacha-iframe { width: 100%; height: 100%; border: none; }
        #gacha-modal-close-button {
            position: absolute; top: 15px; right: 15px; width: 40px; height: 40px;
            border-radius: 50%; background-color: rgba(0,0,0,0.5); color: white;
            font-size: 20px; line-height: 1; z-index: 1001; border: 2px solid white;
            padding: 0; margin: 0;
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1 id="main-title"></h1>
            <div class="header-controls">
                <span id="version-display"></span>
                <button id="admin-button">ê´€ë¦¬ì ëª¨ë“œ</button>
            </div>
        </header>
        
        <div id="date-display-section">
            <div class="date-box loan-date">
                <h2>ë„ì„œ ëŒ€ì¶œì¼</h2>
                <div id="loan-date-container" class="date-content"></div>
            </div>
            <div class="date-box return-date">
                <h2>ë„ì„œ ë°˜ë‚©ì¼</h2>
                <div id="return-date-container" class="date-content"></div>
            </div>
        </div>

        <div id="chart-container"></div>
    </div>

    <!-- Modals -->
    <div id="admin-code-modal" class="modal">
        <div class="modal-content">
            <h2>ê´€ë¦¬ì ì½”ë“œ ì…ë ¥</h2>
            <input type="password" id="admin-code-input" placeholder="****" maxlength="4">
            <div style="display:flex; gap:10px;">
                <button id="admin-code-confirm" class="modal-save-button">í™•ì¸</button>
                <button id="admin-code-cancel" class="modal-close-button">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <div id="admin-modal" class="modal">
        <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
            <h2>ê´€ë¦¬ì ì„¤ì •</h2>
            
            <h3>í•™ìƒ ê´€ë¦¬</h3>
            <label for="new-student-name-input">ìƒˆ í•™ìƒ ì¶”ê°€:</label>
            <div class="input-group">
                <input type="text" id="new-student-name-input" placeholder="í•™ìƒ ì´ë¦„">
                <button id="add-student-button" style="background-color:#28a745; min-width: 60px;">ì¶”ê°€</button>
            </div>
            <label for="student-select-manage">ê¸°ì¡´ í•™ìƒ ìˆ˜ì •/ì‚­ì œ:</label>
            <select id="student-select-manage"></select>
            <div class="input-group">
                <input type="text" id="edit-student-name-input" placeholder="ìƒˆ ì´ë¦„">
                <button id="edit-student-name-button" style="background-color:#ffc107;">ìˆ˜ì •</button>
            </div>
            <button id="delete-student-button" style="background-color:#dc3545; margin-top: 5px;">ì„ íƒí•œ í•™ìƒ ì‚­ì œ</button>

            <h3>ì¶œì„ ê´€ë¦¬</h3>
            <label for="student-select-attendance">í•™ìƒ ì„ íƒ:</label>
            <select id="student-select-attendance"></select>
            <label for="attendance-count-input">ê°œë³„ ì¶œì„ íšŸìˆ˜ ìˆ˜ì •:</label>
            <input type="number" id="attendance-count-input" min="0">
            <button id="modal-save-button" class="modal-save-button">ê°œë³„ ì €ì¥</button>

            <label for="all-students-count-input">ëª¨ë“  í•™ìƒ ì¶œì„ì¼ ë³€ê²½:</label>
            <input type="number" id="all-students-count-input" min="0">
            <button id="all-students-save-button" style="background-color:#16a34a;">ì¼ê´„ ì €ì¥</button>

            <label for="total-days-input">ì´ë²ˆ ë‹¬ ì´ ì¶œì„ì¼ ìˆ˜ì •:</label>
            <input type="number" id="total-days-input" min="1" max="31">
            <button id="total-days-save-button" style="background-color:#2563eb;">ì´ ì¶œì„ì¼ ì €ì¥</button>

            <h3>ë³´ìƒ ê´€ë¦¬</h3>
            <label for="student-select-reward">í•™ìƒ ì„ íƒ:</label>
            <select id="student-select-reward"></select>
            <div style="display:flex; gap:10px;">
                <button id="reset-gift-13-button" style="background-color:#fd7e14;">13ì¼ ì„ ë¬¼ ì´ˆê¸°í™”</button>
                <button id="reset-gift-18-button" style="background-color:#fd7e14;">18ì¼ ì„ ë¬¼ ì´ˆê¸°í™”</button>
            </div>

            <h3>ë°ì´í„° ê´€ë¦¬</h3>
            <div style="display:flex; gap:10px; margin-top: 10px;">
                <button id="export-data-button" style="background-color:#6c757d;">ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
                <button id="import-data-button" style="background-color:#6c757d;">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <input type="file" id="import-file-input" accept=".json" style="display:none;">
            </div>
             <button id="full-reset-button" style="background-color:#c81e1e; margin-top: 10px;">ì „ì²´ ë°ì´í„° ì´ˆê¸°í™” (ì‹ í•™ê¸°ìš©)</button>

            <button id="modal-close-button" class="modal-close-button" style="margin-top: 20px;">ë‹«ê¸°</button>
        </div>
    </div>

    <div id="gacha-modal" class="modal">
        <div class="modal-content">
            <button id="gacha-modal-close-button">&times;</button>
            <iframe id="gacha-iframe"></iframe>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // =================================================================================
            // 1. ì•± ì„¤ì • ë° ìƒìˆ˜
            // =================================================================================
            const APP_VERSION = "4.0.1";
            const gachaHTML = `<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><title>ë½‘ê¸°</title><style>body{font-family:sans-serif;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;margin:0;background-color:#f0f4f8;overflow:hidden}.gacha-container{text-align:center;background:#fff;padding:2vh 2vw;border-radius:20px;width:100%;height:100%;box-sizing:border-box;position:relative;overflow:hidden;display:flex;flex-direction:column;justify-content:center;align-items:center}h1{color:#d9534f;font-size:clamp(2em, 5vh, 3em);margin:0 0 2vh 0}.gacha-machine{width:80%;max-width:300px;height:50vh;max-height:400px;background-image:url(https://i.pinimg.com/1200x/ea/8f/81/ea8f81f6ae8d02a0f1731b93e9ffaad7.jpg);background-size:contain;background-repeat:no-repeat;background-position:center;margin:2vh auto}.gacha-button{padding:2vh 4vw;font-size:clamp(1em, 3vh, 1.5em);font-weight:700;color:#fff;background-color:#5cb85c;border:none;border-radius:12px;cursor:pointer;transition:all .2s;box-shadow:0 4px 6px rgba(0,0,0,.1)}.gacha-button:active{transform:scale(.98)}#gacha-ball{position:absolute;left:50%;transform:translateX(-50%);width:clamp(150px, 30vh, 250px);height:clamp(150px, 30vh, 250px);border-radius:50%;box-shadow:0 4px 8px rgba(0,0,0,.2);display:none;flex-direction:column;align-items:center;justify-content:center;text-align:center;font-size:clamp(1em, 2.5vh, 1.2em);font-weight:700;color:#fff;padding:10px;box-sizing:border-box;cursor:pointer}@keyframes fall-and-reveal{0%{top:20%;transform:translateX(-50%) scale(.5);opacity:0}100%{top:70%;transform:translateX(-50%) scale(1);opacity:1}}.animate-ball{animation:fall-and-reveal 5s forwards}<\/style><script src="https://cdn.jsdelivr.net/npm/tone@14.7.58/build/Tone.js"><\/script><\/head><body><div class="gacha-container"><h1>ê½ ì—†ëŠ” ë½‘ê¸° ê¸°ê³„<\/h1><div class="gacha-machine"><\/div><button id="gacha-button" class="gacha-button">ë½‘ê¸°!<\/button><div id="gacha-ball"><\/div><\/div><script>const items=['1ë“± ìƒí’ˆ: ë©‹ì§„ ìƒí’ˆ','2ë“± ìƒí’ˆ: ìƒí’ˆê¶Œ','3ë“± ë‹¹ì²¨: í• ì¸ì¿ í°','4ë“± ë‹¹ì²¨: ì‘ì€ ì„ ë¬¼','5ë“± ë‹¹ì²¨: ì»¤í”¼ ì¿ í°','ì¶•í•˜í•©ë‹ˆë‹¤! ì‚¬íƒ• íšë“','íŠ¹ë³„ìƒ: ì´ˆì½œë¦¿ êµí™˜ê¶Œ','í–‰ìš´ìƒ: ë§ˆì´ì®¸','í–‰ë³µìƒ: ì ¤ë¦¬','ëŒ€ë°•ìƒ: ê³¼ì ì„¸íŠ¸','ì•„ì´í…œ 1','ì•„ì´í…œ 2','ì•„ì´í…œ 3','ì•„ì´í…œ 4','ì•„ì´í…œ 5','ì•„ì´í…œ 6','ì•„ì´í…œ 7','ì•„ì´í…œ 8','ì•„ì´í…œ 9','ì•„ì´í…œ 10','ì•„ì´í…œ 11','ì•„ì´í…œ 12','ì•„ì´í…œ 13','ì•„ì´í…œ 14','ì•„ì´í…œ 15','ì•„ì´í…œ 16','ì•„ì´í…œ 17','ì•„ì´í…œ 18','ì•„ì´í…œ 19','ì•„ì´í…œ 20','ì•„ì´í…œ 21','ì•„ì´í…œ 22','ì•„ì´í…œ 23'];const ballColors=['#ff6347','#ffb6c1','#add8e6','#90ee90','#ffa07a','#c0c0c0','#d8bfd8','#f0e68c'];const synth=new Tone.NoiseSynth({noise:{type:"brown"},envelope:{attack:.02,decay:.2,sustain:.05}}).toDestination();const ball=document.getElementById('gacha-ball'),button=document.getElementById('gacha-button');let isAnimating=!1;async function drawItem(){if(isAnimating)return;isAnimating=!0;await Tone.start();ball.style.backgroundColor=ballColors[Math.floor(Math.random()*ballColors.length)];ball.style.display='flex';ball.innerText='';synth.triggerAttackRelease("3s");ball.classList.remove('animate-ball');void ball.offsetWidth;ball.classList.add('animate-ball');button.disabled=!0;setTimeout(()=>{const selectedItem=items[Math.floor(Math.random()*items.length)];ball.innerText=\`ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! \${selectedItem} ë‹¹ì²¨! ğŸ‰\`;button.disabled=!1;isAnimating=!1},5e3)}button.addEventListener('click',drawItem);ball.addEventListener('click',()=>{if(!isAnimating)ball.style.display='none'});<\/script><\/body><\/html>`;
            
            // DOM Elements
            const chartContainer = document.getElementById('chart-container');
            const mainTitle = document.getElementById('main-title');
            const versionDisplay = document.getElementById('version-display');

            // State Variables
            let studentData = [];
            let initialStudentNames = [];
            let TOTAL_DAYS_IN_MONTH;
            let audioCtx;
            
            const cardColors = ['#eff6ff', '#f0fdf4', '#fefce8', '#fef2f2', '#faf5ff', '#fdf2f8', '#eef2ff', '#f0fdfa'];
            const buttonColors = ['#2563eb', '#16a34a', '#ca8a04', '#dc2626', '#9333ea', '#db2777', '#4f46e5', '#0d9488'];

            // Date Constants
            const today = new Date();
            const currentMonth = today.getMonth();

            // =================================================================================
            // 2. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ (ë‚ ì§œ, ì†Œë¦¬ ë“±)
            // =================================================================================
            function getTodayDateString() { return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`; }
            function getCurrentMonthString() { return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`; }
            
            function playSound(type) {
                if (!audioCtx) { try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch (e) { return; } }
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                if (type === 'check-in') {
                    oscillator.type = 'triangle';
                    gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.02);
                    oscillator.frequency.setValueAtTime(1500, audioCtx.currentTime);
                } else {
                    oscillator.type = 'triangle';
                    gainNode.gain.setValueAtTime(0.4, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.03);
                    oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
                }
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + 0.03);
            }

            // =================================================================================
            // 3. ë°ì´í„° ê´€ë¦¬ í•¨ìˆ˜
            // =================================================================================
            function initializeData() {
                const storedData = JSON.parse(localStorage.getItem('libraryAttendanceData'));
                const currentMonthStr = getCurrentMonthString();

                if (storedData && storedData.month === currentMonthStr) {
                    studentData = storedData.students;
                    initialStudentNames = storedData.studentNames || initialStudentNames;
                    TOTAL_DAYS_IN_MONTH = storedData.totalDays || 20;
                    studentData.forEach(s => { if (!s.usedGachas) s.usedGachas = []; });
                } else {
                    if (storedData) localStorage.setItem(`history_${storedData.month}`, JSON.stringify(storedData));
                    TOTAL_DAYS_IN_MONTH = 20;
                    initialStudentNames = [
                        'ì´ì§€í•œ', 'ì¥ë³„', 'ì´ê¸°ì›', 'ì´ë‹¤ê²½', 'ìµœì˜¨ìœ ', 'ì£¼í•˜ì—˜', 'ê¹€ì„¸í˜„', 'ì•ˆì„œìœ¤', 'ì •í•´ë‚˜', 'ì›ì†Œì •', 
                        'ìš°ì°¬ì˜', 'ì „ì œì¤€', 'ê°•í•œë´„', 'ì´ê¸°ì›…', 'ìš©í•´ì¸', 'ì´íš¨ìœ¨', 'ì¥ì„¤', 'ì´í•˜ìœ¤', 'ê³½ì¬ì€', 'ê¹€íƒœì´', 
                        'ê°•ì‹œí˜¸', 'ì •ëª¨ì„¸', 'ê¹€ë„í¬', 'ê¹€ë¼ì—˜', 'ì´ê¸°ë°±', 'ì´ê±´ìš°', 'ê¹€ë‹¤ì¸', 'ê¹€ë„ì¤€', 'ì‹ ì§€ìš°', 'í•œì¬ì´', 
                        'ì‹ ìˆ˜ë¹ˆ', 'ë°•ì§€ìœ ', 'ê¶Œë„ì—°', 'ìš°ì˜ˆë¹ˆ', 'ê¹€ë„í›ˆ', 'ì°¨íƒœí˜¸', 'ë°•ê²½ë¯¼', 'ê¶Œë‚˜ìœ¤', 'ê°•í•œì•„'
                    ].reverse();
                    studentData = initialStudentNames.map(name => ({ name, attendanceCount: 0, lastCheckInDate: null, usedGachas: [] }));
                }
                saveData();
            }
            function saveData() {
                localStorage.setItem('libraryAttendanceData', JSON.stringify({
                    month: getCurrentMonthString(),
                    totalDays: TOTAL_DAYS_IN_MONTH,
                    studentNames: initialStudentNames,
                    students: studentData
                }));
            }

            // =================================================================================
            // 4. UI ë Œë”ë§ í•¨ìˆ˜
            // =================================================================================
            function renderStudents() {
                chartContainer.innerHTML = '';
                
                studentData.forEach((student, studentIndex) => {
                    const card = document.createElement('div');
                    card.className = 'student-card';
                    const colorIndex = initialStudentNames.indexOf(student.name) % cardColors.length;
                    card.style.backgroundColor = cardColors[colorIndex];
                    
                    const hasAttendedToday = student.lastCheckInDate === getTodayDateString();

                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'student-name';
                    nameDiv.textContent = student.name;
                    
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'attendance-info';
                    infoDiv.innerHTML = `
                        <span class="count">${student.attendanceCount}</span>
                        <span class="label"> / ${TOTAL_DAYS_IN_MONTH}íšŒ</span>
                    `;

                    const buttonsDiv = document.createElement('div');
                    buttonsDiv.className = 'action-buttons';

                    const mainBtn = document.createElement('button');
                    mainBtn.className = 'circular-btn';
                    
                    if (hasAttendedToday) {
                        mainBtn.textContent = 'ì„±ê³µ! ğŸ‰';
                        mainBtn.classList.add('undo-btn');
                        mainBtn.onclick = () => handleUndo(studentIndex);
                    } else {
                        mainBtn.textContent = 'ì¶œì„';
                        mainBtn.style.backgroundColor = buttonColors[colorIndex];
                        mainBtn.onclick = () => handleCheckIn(studentIndex);
                    }
                    
                    const giftContainer = document.createElement('div');
                    giftContainer.className = 'gift-btn-container';
                    [13, 18].forEach(day => {
                        if (student.attendanceCount >= day) {
                            const giftBtn = document.createElement('button');
                            giftBtn.className = 'circular-btn gift-btn';
                            giftBtn.innerHTML = 'ğŸ';
                            giftBtn.title = `${day}ì¼ ì¶œì„ ì„ ë¬¼`;
                            if (student.usedGachas.includes(day)) {
                                giftBtn.disabled = true;
                            }
                            giftBtn.onclick = () => {
                                student.usedGachas.push(day);
                                saveData();
                                renderStudents();
                                openGachaModal();
                            };
                            giftContainer.appendChild(giftBtn);
                        }
                    });

                    buttonsDiv.appendChild(mainBtn);
                    if (giftContainer.hasChildNodes()) {
                        buttonsDiv.appendChild(giftContainer);
                    }

                    card.appendChild(nameDiv);
                    card.appendChild(infoDiv);
                    card.appendChild(buttonsDiv);
                    
                    chartContainer.appendChild(card);
                });
            }

            function renderDateDisplay() {
                const koreanHolidays = new Set(['2024-01-01', '2024-02-09', '2024-02-10', '2024-02-11', '2024-02-12', '2024-03-01', '2024-04-10', '2024-05-01', '2024-05-05', '2024-05-06', '2024-05-15', '2024-06-06', '2024-08-15', '2024-09-16', '2024-09-17', '2024-09-18', '2024-10-03', '2024-10-09', '2024-12-25', '2025-01-01', '2025-01-28', '2025-01-29', '2025-01-30', '2025-03-01', '2025-05-05', '2025-05-06', '2025-06-06', '2025-08-15', '2025-10-03', '2025-10-06', '2025-10-07', '2025-10-08', '2025-10-09', '2025-12-25']);
                function isWeekendOrHoliday(date) {
                    const day = date.getDay();
                    if (day === 0 || day === 6) return true;
                    const dateString = date.getFullYear() + '-' + ('0' + (date.getMonth() + 1)).slice(-2) + '-' + ('0' + date.getDate()).slice(-2);
                    return koreanHolidays.has(dateString);
                }
                function formatDateToHTML(date) {
                    const month = date.getMonth() + 1;
                    const dayOfMonth = date.getDate();
                    const dayOfWeek = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][date.getDay()];
                    return `<span class="date-number">${month}</span><span class="date-text">ì›”</span><span class="date-number">${dayOfMonth}</span><span class="date-text">ì¼ (${dayOfWeek})</span>`;
                }
                const loanDate = new Date();
                document.getElementById('loan-date-container').innerHTML = formatDateToHTML(loanDate);
                const returnDate = new Date();
                returnDate.setDate(loanDate.getDate() + 14);
                while (isWeekendOrHoliday(returnDate)) {
                    returnDate.setDate(returnDate.getDate() + 1);
                }
                document.getElementById('return-date-container').innerHTML = formatDateToHTML(returnDate);
            }

            // =================================================================================
            // 5. ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ í•¨ìˆ˜
            // =================================================================================
            function handleCheckIn(studentIndex) {
                const student = studentData[studentIndex];
                if (student.lastCheckInDate === getTodayDateString()) return;
                playSound('check-in');
                student.attendanceCount++;
                student.lastCheckInDate = getTodayDateString();
                saveData();
                renderStudents();
            }
            function handleUndo(studentIndex) {
                const student = studentData[studentIndex];
                if (student.lastCheckInDate === getTodayDateString()) {
                    playSound('undo');
                    student.attendanceCount--;
                    student.lastCheckInDate = null;
                    saveData();
                    renderStudents();
                }
            }
            function openGachaModal() {
                document.getElementById('gacha-iframe').srcdoc = gachaHTML;
                document.getElementById('gacha-modal').style.display = 'flex';
            }
            function setupEventListeners() {
                const adminCodeModal = document.getElementById('admin-code-modal');
                const adminCodeInput = document.getElementById('admin-code-input');
                document.getElementById('admin-button').onclick = () => {
                    adminCodeInput.value = '';
                    adminCodeModal.style.display = 'flex';
                    adminCodeInput.focus();
                };
                document.getElementById('admin-code-cancel').onclick = () => adminCodeModal.style.display = 'none';
                document.getElementById('admin-code-confirm').onclick = () => {
                    if (adminCodeInput.value === '6408') {
                        adminCodeModal.style.display = 'none';
                        openAdminModal();
                    } else {
                        alert('ì½”ë“œê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                        adminCodeInput.value = '';
                    }
                };
                const gachaModal = document.getElementById('gacha-modal');
                document.getElementById('gacha-modal-close-button').onclick = () => {
                    document.getElementById('gacha-iframe').srcdoc = '';
                    gachaModal.style.display = 'none';
                };
            }
            
            function openAdminModal() {
                const adminModal = document.getElementById('admin-modal');
                const selects = ['student-select-manage', 'student-select-attendance', 'student-select-reward'];
                selects.forEach(id => {
                    const select = document.getElementById(id);
                    select.innerHTML = studentData.map((s, i) => `<option value="${i}">${s.name}</option>`).join('');
                });
                document.getElementById('total-days-input').value = TOTAL_DAYS_IN_MONTH;
                document.getElementById('attendance-count-input').max = TOTAL_DAYS_IN_MONTH;
                document.getElementById('all-students-count-input').max = TOTAL_DAYS_IN_MONTH;
                adminModal.style.display = 'flex';
            }

            function setupAdminModalListeners() {
                const adminModal = document.getElementById('admin-modal');
                document.getElementById('modal-close-button').onclick = () => adminModal.style.display = 'none';
                document.getElementById('add-student-button').onclick = () => {
                    const nameInput = document.getElementById('new-student-name-input');
                    const newName = nameInput.value.trim();
                    if (newName && !initialStudentNames.includes(newName)) {
                        initialStudentNames.push(newName);
                        studentData.push({ name: newName, attendanceCount: 0, lastCheckInDate: null, usedGachas: [] });
                        saveData();
                        renderStudents();
                        openAdminModal();
                        nameInput.value = '';
                    } else { alert('ì´ë¦„ì„ ì…ë ¥í•˜ì§€ ì•Šì•˜ê±°ë‚˜ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë¦„ì…ë‹ˆë‹¤.'); }
                };
                document.getElementById('edit-student-name-button').onclick = () => {
                    const select = document.getElementById('student-select-manage');
                    const nameInput = document.getElementById('edit-student-name-input');
                    const newName = nameInput.value.trim();
                    if (newName && !initialStudentNames.includes(newName)) {
                        const studentIndex = parseInt(select.value);
                        const oldName = studentData[studentIndex].name;
                        studentData[studentIndex].name = newName;
                        initialStudentNames[initialStudentNames.indexOf(oldName)] = newName;
                        saveData();
                        renderStudents();
                        openAdminModal();
                        nameInput.value = '';
                    } else { alert('ìƒˆ ì´ë¦„ì„ ì…ë ¥í•˜ì§€ ì•Šì•˜ê±°ë‚˜ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë¦„ì…ë‹ˆë‹¤.'); }
                };
                document.getElementById('delete-student-button').onclick = () => {
                    const select = document.getElementById('student-select-manage');
                    const studentIndex = parseInt(select.value);
                    const studentName = studentData[studentIndex].name;
                    if (confirm(`'${studentName}' í•™ìƒì„ ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        studentData.splice(studentIndex, 1);
                        initialStudentNames = initialStudentNames.filter(name => name !== studentName);
                        saveData();
                        renderStudents();
                        openAdminModal();
                    }
                };
                document.getElementById('modal-save-button').onclick = () => {
                    const s = document.getElementById('student-select-attendance');
                    const i = document.getElementById('attendance-count-input');
                    const newCount = parseInt(i.value, 10);
                    if (!isNaN(newCount) && newCount >= 0 && newCount <= TOTAL_DAYS_IN_MONTH) {
                        studentData[s.value].attendanceCount = newCount;
                        studentData[s.value].lastCheckInDate = null;
                        saveData();
                        renderStudents();
                        alert('í•™ìƒ ì¶œì„ì¼ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    } else { alert('ìœ íš¨í•œ ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); }
                };
                document.getElementById('all-students-save-button').onclick = () => {
                    const i = document.getElementById('all-students-count-input');
                    const newCount = parseInt(i.value, 10);
                    if (!isNaN(newCount) && newCount >= 0 && newCount <= TOTAL_DAYS_IN_MONTH) {
                        if (confirm(`ì •ë§ë¡œ ëª¨ë“  í•™ìƒì˜ ì¶œì„ì¼ì„ ${newCount}ì¼ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                            studentData.forEach(student => {
                                student.attendanceCount = newCount;
                                student.lastCheckInDate = null;
                            });
                            saveData();
                            renderStudents();
                            alert('ëª¨ë“  í•™ìƒì˜ ì¶œì„ì¼ì´ ì¼ê´„ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        }
                    } else { alert('ìœ íš¨í•œ ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); }
                };
                document.getElementById('total-days-save-button').onclick = () => {
                    const totalDaysInput = document.getElementById('total-days-input');
                    const newTotalDays = parseInt(totalDaysInput.value, 10);
                    if (!isNaN(newTotalDays) && newTotalDays >= 1 && newTotalDays <= 31) {
                        TOTAL_DAYS_IN_MONTH = newTotalDays;
                        saveData();
                        renderStudents();
                        alert(`ì´ ì¶œì„ì¼ì´ ${newTotalDays}ì¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                        adminModal.style.display = 'none';
                    } else { alert('1ì—ì„œ 31 ì‚¬ì´ì˜ ìœ íš¨í•œ ì¼ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); }
                };
                document.getElementById('reset-gift-13-button').onclick = () => resetGift(13);
                document.getElementById('reset-gift-18-button').onclick = () => resetGift(18);
                function resetGift(day) {
                    const select = document.getElementById('student-select-reward');
                    const studentIndex = parseInt(select.value);
                    const student = studentData[studentIndex];
                    student.usedGachas = student.usedGachas.filter(gachaDay => gachaDay !== day);
                    saveData();
                    renderStudents();
                    alert(`'${student.name}' í•™ìƒì˜ ${day}ì¼ ì„ ë¬¼ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                }
                document.getElementById('export-data-button').onclick = () => {
                    const dataStr = JSON.stringify(JSON.parse(localStorage.getItem('libraryAttendanceData')), null, 2);
                    const dataBlob = new Blob([dataStr], {type : 'application/json'});
                    const url = URL.createObjectURL(dataBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `ë„ë‹´ë§ˆë£¨_ì¶œì„ê¸°ë¡_${getCurrentMonthString()}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                };
                const fileInput = document.getElementById('import-file-input');
                document.getElementById('import-data-button').onclick = () => fileInput.click();
                fileInput.onchange = (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const importedData = JSON.parse(e.target.result);
                                if (importedData.month && importedData.students && importedData.studentNames) {
                                    if(confirm("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ë©´ í˜„ì¬ ê¸°ë¡ì´ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                                        localStorage.setItem('libraryAttendanceData', JSON.stringify(importedData));
                                        init();
                                        alert("ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.");
                                        adminModal.style.display = 'none';
                                    }
                                } else { alert("íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."); }
                            } catch (error) { alert("íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }
                        };
                        reader.readAsText(file);
                    }
                };
                document.getElementById('full-reset-button').onclick = () => {
                    if (confirm("ì •ë§ë¡œ ëª¨ë“  í•™ìƒì˜ ì¶œì„ ê¸°ë¡ê³¼ ì„ ë¬¼ ê¸°ë¡ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) {
                        studentData.forEach(student => {
                            student.attendanceCount = 0;
                            student.lastCheckInDate = null;
                            student.usedGachas = [];
                        });
                        saveData();
                        renderStudents();
                        alert("ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        adminModal.style.display = 'none';
                    }
                };
            }

            // =================================================================================
            // 6. ì•± ì´ˆê¸°í™”
            // =================================================================================
            function init() {
                versionDisplay.textContent = `v${APP_VERSION}`;
                mainTitle.textContent = `${currentMonth + 1}ì›” ë„ë‹´ë§ˆë£¨ ë„ì„œê´€ ì¶œì„ë¶€ ğŸ“š`;
                initializeData();
                renderStudents();
                renderDateDisplay();
                setupEventListeners();
                setupAdminModalListeners();
            }

            init();
        });
    </script>
</body>
</html>
